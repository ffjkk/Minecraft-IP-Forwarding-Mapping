<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内网穿透代理服务器管理面板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .log-container {
            height: 400px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
        }
        .log-entry {
            padding: 2px 8px;
            border-left: 3px solid transparent;
        }
        .log-entry.success {
            border-left-color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }
        .log-entry.info {
            border-left-color: #17a2b8;
            background-color: rgba(23, 162, 184, 0.1);
        }
        .log-entry.warning {
            border-left-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }
        .log-entry.error {
            border-left-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }
        .connection-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        .connection-item:hover {
            transform: scale(1.02);
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        .card-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .status-online {
            color: #28a745;
        }
        .status-offline {
            color: #dc3545;
        }
        .chart-container {
            height: 300px;
        }
    </style>
</head>
<body class="bg-light">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-router"></i> 内网穿透代理服务器
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="bi bi-circle-fill" id="connection-status"></i>
                    <span id="connection-text">连接中...</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 状态卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2" id="total-connections">0</h4>
                        <p class="text-muted mb-0">总连接数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-lightning-fill text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2" id="active-connections">0</h4>
                        <p class="text-muted mb-0">活跃连接</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-hdd-network text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2" id="active-ports">0</h4>
                        <p class="text-muted mb-0">活跃端口</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-arrow-left-right text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2" id="total-mappings">0</h4>
                        <p class="text-muted mb-0">端口映射</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 端口配置管理 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-gear"></i> 端口配置管理
                        <div class="float-end">
                            <button class="btn btn-primary btn-sm" onclick="showAddPortModal()">
                                <i class="bi bi-plus"></i> 添加端口
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="portConfigTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="ranges-tab" data-bs-toggle="tab" data-bs-target="#ranges" type="button" role="tab">
                                    端口范围
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="specific-tab" data-bs-toggle="tab" data-bs-target="#specific" type="button" role="tab">
                                    特定端口
                                </button>
                            </li>
                        </ul>
                        <div class="tab-content" id="portConfigTabContent">
                            <div class="tab-pane fade show active" id="ranges" role="tabpanel">
                                <div class="mt-3">
                                    <div id="port-ranges-list">
                                        <!-- 端口范围列表将在这里动态加载 -->
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="specific" role="tabpanel">
                                <div class="mt-3">
                                    <div id="specific-ports-list">
                                        <!-- 特定端口列表将在这里动态加载 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 服务器信息 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i> 服务器信息
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <strong>运行时间:</strong><br>
                                <span id="uptime">0分钟</span>
                            </div>
                            <div class="col-6">
                                <strong>数据传输:</strong><br>
                                <span id="data-transferred">0 B</span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>外部端口:</strong><br>
                                <span class="badge bg-primary">25565</span>
                            </div>
                            <div class="col-6">
                                <strong>内网端口:</strong><br>
                                <span class="badge bg-success">9000</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> 连接统计
                    </div>
                    <div class="card-body">
                        <canvas id="connectionChart" class="chart-container"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 活跃连接和日志 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-link-45deg"></i> 活跃连接
                        <span class="badge bg-light text-dark ms-2" id="active-count-badge">0</span>
                    </div>
                    <div class="card-body">
                        <div id="active-connections-list" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">暂无活跃连接</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-terminal"></i> 实时日志
                        <button class="btn btn-sm btn-light ms-2" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> 清空
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="log-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加端口模态框 -->
    <div class="modal fade" id="addPortModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPortModalLabel">添加端口配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addPortForm">
                        <div class="mb-3">
                            <label for="portType" class="form-label">端口类型</label>
                            <select class="form-select" id="portType" onchange="togglePortTypeFields()">
                                <option value="range">端口范围</option>
                                <option value="specific">特定端口</option>
                            </select>
                        </div>
                        
                        <div id="rangeFields">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="startPort" class="form-label">起始端口</label>
                                    <input type="number" class="form-control" id="startPort" min="1" max="65535">
                                </div>
                                <div class="col-md-6">
                                    <label for="endPort" class="form-label">结束端口</label>
                                    <input type="number" class="form-control" id="endPort" min="1" max="65535">
                                </div>
                            </div>
                        </div>
                        
                        <div id="specificFields" style="display: none;">
                            <div class="mb-3">
                                <label for="specificPort" class="form-label">端口号</label>
                                <input type="number" class="form-control" id="specificPort" min="1" max="65535">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="portName" class="form-label">名称</label>
                            <input type="text" class="form-control" id="portName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="portDescription" class="form-label">描述</label>
                            <textarea class="form-control" id="portDescription" rows="2"></textarea>
                        </div>
                        
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="portEnabled" checked>
                            <label class="form-check-label" for="portEnabled">
                                启用此端口配置
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addPortConfig()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Socket.IO连接
        const socket = io();
        
        // 图表配置
        const ctx = document.getElementById('connectionChart').getContext('2d');
        const connectionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '活跃连接数',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 连接状态管理
        socket.on('connect', () => {
            document.getElementById('connection-status').className = 'bi bi-circle-fill status-online';
            document.getElementById('connection-text').textContent = '已连接';
        });

        socket.on('disconnect', () => {
            document.getElementById('connection-status').className = 'bi bi-circle-fill status-offline';
            document.getElementById('connection-text').textContent = '连接断开';
        });

        // 统计信息更新
        socket.on('stats-update', (stats) => {
            document.getElementById('total-connections').textContent = stats.totalConnections;
            document.getElementById('active-connections').textContent = stats.activeConnectionsCount;
            document.getElementById('active-ports').textContent = stats.activePorts || 0;
            document.getElementById('total-mappings').textContent = stats.totalMappings || 0;
            
            // 更新运行时间
            const uptimeMs = stats.uptime;
            const hours = Math.floor(uptimeMs / (1000 * 60 * 60));
            const minutes = Math.floor((uptimeMs % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('uptime').textContent = `${hours}小时${minutes}分钟`;
            
            // 更新数据传输量
            document.getElementById('data-transferred').textContent = formatBytes(stats.totalDataTransferred);
            
            // 更新图表
            const now = new Date().toLocaleTimeString();
            if (connectionChart.data.labels.length > 20) {
                connectionChart.data.labels.shift();
                connectionChart.data.datasets[0].data.shift();
            }
            connectionChart.data.labels.push(now);
            connectionChart.data.datasets[0].data.push(stats.activeConnectionsCount);
            connectionChart.update();
        });

        // 活跃连接更新
        socket.on('active-connections', (connections) => {
            updateActiveConnections(connections);
        });

        // 连接事件
        socket.on('connection-event', (event) => {
            if (event.event === 'established') {
                addActiveConnection(event.data);
            } else if (event.event === 'closed') {
                removeActiveConnection(event.data.id);
            }
        });

        // 日志消息
        socket.on('log-message', (log) => {
            addLogEntry(log.level, log.message, log.timestamp);
        });

        // 更新活跃连接列表
        function updateActiveConnections(connections) {
            const container = document.getElementById('active-connections-list');
            
            if (connections.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">暂无活跃连接</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = connections.map(conn => `
                <div class="connection-item" id="connection-${conn.id}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>连接 #${conn.id}</strong>
                            <br>
                            <small>${conn.externalIP} ↔ ${conn.localIP}</small>
                        </div>
                        <div class="text-end">
                            <div class="badge bg-light text-dark">${formatBytes(conn.bytesTransferred)}</div>
                            <br>
                            <small>${formatDuration(Date.now() - new Date(conn.startTime).getTime())}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // 添加活跃连接
        function addActiveConnection(connection) {
            const container = document.getElementById('active-connections-list');
            
            // 如果是空状态，清空容器
            if (container.querySelector('.text-center')) {
                container.innerHTML = '';
            }
            
            const connectionElement = document.createElement('div');
            connectionElement.className = 'connection-item';
            connectionElement.id = `connection-${connection.id}`;
            connectionElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>连接 #${connection.id}</strong>
                        <br>
                        <small>${connection.externalIP} ↔ ${connection.localIP}</small>
                    </div>
                    <div class="text-end">
                        <div class="badge bg-light text-dark">${formatBytes(connection.bytesTransferred)}</div>
                        <br>
                        <small>刚刚建立</small>
                    </div>
                </div>
            `;
            
            container.insertBefore(connectionElement, container.firstChild);
        }

        // 移除活跃连接
        function removeActiveConnection(connectionId) {
            const element = document.getElementById(`connection-${connectionId}`);
            if (element) {
                element.style.transition = 'all 0.5s ease';
                element.style.opacity = '0';
                element.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    element.remove();
                    
                    // 检查是否需要显示空状态
                    const container = document.getElementById('active-connections-list');
                    if (container.children.length === 0) {
                        container.innerHTML = `
                            <div class="text-center text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">暂无活跃连接</p>
                            </div>
                        `;
                    }
                }, 500);
            }
        }

        // 添加日志条目
        function addLogEntry(level, message, timestamp) {
            const container = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            
            const time = new Date(timestamp).toLocaleTimeString();
            logEntry.innerHTML = `
                <span class="text-muted">[${time}]</span> 
                <span class="${level === 'error' ? 'text-danger' : level === 'warning' ? 'text-warning' : level === 'success' ? 'text-success' : 'text-info'}">[${level.toUpperCase()}]</span> 
                ${message}
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // 限制日志条目数量
            if (container.children.length > 500) {
                container.removeChild(container.firstChild);
            }
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
        }

        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化持续时间
        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}时${minutes % 60}分`;
            } else if (minutes > 0) {
                return `${minutes}分${seconds % 60}秒`;
            } else {
                return `${seconds}秒`;
            }
        }

        // 端口配置管理
        let currentConfig = null;
        
        // 加载配置
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                currentConfig = await response.json();
                updatePortConfigDisplay();
            } catch (error) {
                console.error('加载配置失败:', error);
            }
        }
        
        // 更新端口配置显示
        function updatePortConfigDisplay() {
            if (!currentConfig) return;
            
            // 更新端口范围
            const rangesList = document.getElementById('port-ranges-list');
            rangesList.innerHTML = currentConfig.portRanges.map(range => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${range.name}</h6>
                                <small class="text-muted">端口范围: ${range.startPort} - ${range.endPort}</small>
                                <br>
                                <small class="text-info">${range.description || '无描述'}</small>
                            </div>
                            <div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" ${range.enabled ? 'checked' : ''} 
                                           onchange="togglePortRange('${range.id}')">
                                </div>
                                <button class="btn btn-danger btn-sm mt-1" onclick="deletePortRange('${range.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // 更新特定端口
            const specificList = document.getElementById('specific-ports-list');
            specificList.innerHTML = currentConfig.specificPorts.map(port => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${port.name}</h6>
                                <small class="text-muted">端口: ${port.port}</small>
                                <br>
                                <small class="text-info">${port.description || '无描述'}</small>
                            </div>
                            <div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" ${port.enabled ? 'checked' : ''} 
                                           onchange="toggleSpecificPort('${port.id}')">
                                </div>
                                <button class="btn btn-danger btn-sm mt-1" onclick="deleteSpecificPort('${port.id}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 显示添加端口模态框
        function showAddPortModal() {
            document.getElementById('addPortForm').reset();
            document.getElementById('portEnabled').checked = true;
            togglePortTypeFields();
            const modal = new bootstrap.Modal(document.getElementById('addPortModal'));
            modal.show();
        }
        
        // 切换端口类型字段
        function togglePortTypeFields() {
            const portType = document.getElementById('portType').value;
            const rangeFields = document.getElementById('rangeFields');
            const specificFields = document.getElementById('specificFields');
            
            if (portType === 'range') {
                rangeFields.style.display = 'block';
                specificFields.style.display = 'none';
            } else {
                rangeFields.style.display = 'none';
                specificFields.style.display = 'block';
            }
        }
        
        // 添加端口配置
        async function addPortConfig() {
            const portType = document.getElementById('portType').value;
            const name = document.getElementById('portName').value;
            const description = document.getElementById('portDescription').value;
            const enabled = document.getElementById('portEnabled').checked;
            
            if (!name) {
                alert('请输入名称');
                return;
            }
            
            const newConfig = { ...currentConfig };
            const id = Date.now().toString();
            
            if (portType === 'range') {
                const startPort = parseInt(document.getElementById('startPort').value);
                const endPort = parseInt(document.getElementById('endPort').value);
                
                if (!startPort || !endPort || startPort > endPort) {
                    alert('请输入有效的端口范围');
                    return;
                }
                
                newConfig.portRanges.push({
                    id,
                    name,
                    type: 'range',
                    startPort,
                    endPort,
                    enabled,
                    description
                });
            } else {
                const port = parseInt(document.getElementById('specificPort').value);
                
                if (!port || port < 1 || port > 65535) {
                    alert('请输入有效的端口号 (1-65535)');
                    return;
                }
                
                newConfig.specificPorts.push({
                    id,
                    port,
                    name,
                    enabled,
                    description
                });
            }
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newConfig)
                });
                
                if (response.ok) {
                    currentConfig = newConfig;
                    updatePortConfigDisplay();
                    bootstrap.Modal.getInstance(document.getElementById('addPortModal')).hide();
                } else {
                    const error = await response.json();
                    alert('保存失败: ' + error.message);
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }
        
        // 切换端口范围状态
        async function togglePortRange(id) {
            const newConfig = { ...currentConfig };
            const range = newConfig.portRanges.find(r => r.id === id);
            if (range) {
                range.enabled = !range.enabled;
                await saveConfig(newConfig);
            }
        }
        
        // 切换特定端口状态
        async function toggleSpecificPort(id) {
            const newConfig = { ...currentConfig };
            const port = newConfig.specificPorts.find(p => p.id === id);
            if (port) {
                port.enabled = !port.enabled;
                await saveConfig(newConfig);
            }
        }
        
        // 删除端口范围
        async function deletePortRange(id) {
            if (confirm('确定要删除这个端口范围吗？')) {
                const newConfig = { ...currentConfig };
                newConfig.portRanges = newConfig.portRanges.filter(r => r.id !== id);
                await saveConfig(newConfig);
            }
        }
        
        // 删除特定端口
        async function deleteSpecificPort(id) {
            if (confirm('确定要删除这个端口吗？')) {
                const newConfig = { ...currentConfig };
                newConfig.specificPorts = newConfig.specificPorts.filter(p => p.id !== id);
                await saveConfig(newConfig);
            }
        }
        
        // 保存配置
        async function saveConfig(config) {
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    currentConfig = config;
                    updatePortConfigDisplay();
                } else {
                    const error = await response.json();
                    alert('保存失败: ' + error.message);
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
            }
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
        });
    </script>
</body>
</html>
