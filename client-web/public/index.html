<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>内网穿透客户端管理面板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-card {
            transition: all 0.3s ease;
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .log-container {
            height: 400px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: 'Courier New', monospace;
        }
        .log-entry {
            padding: 2px 8px;
            border-left: 3px solid transparent;
        }
        .log-entry.success {
            border-left-color: #28a745;
            background-color: rgba(40, 167, 69, 0.1);
        }
        .log-entry.info {
            border-left-color: #17a2b8;
            background-color: rgba(23, 162, 184, 0.1);
        }
        .log-entry.warning {
            border-left-color: #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }
        .log-entry.error {
            border-left-color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }
        .connection-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        .connection-item:hover {
            transform: scale(1.02);
        }
        .connection-item.failed {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }
        .connection-item.active {
            background: linear-gradient(135deg, #00d2d3 0%, #54a0ff 100%);
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }
        .card-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .status-online {
            color: #28a745;
        }
        .status-offline {
            color: #dc3545;
        }
        .status-connecting {
            color: #ffc107;
        }
        .chart-container {
            height: 300px;
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .status-connected {
            background-color: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        .status-disconnected {
            background-color: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        .status-error {
            background-color: rgba(255, 193, 7, 0.2);
            color: #856404;
        }
    </style>
</head>
<body class="bg-light">
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-laptop"></i> 内网穿透客户端
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="bi bi-circle-fill" id="connection-status"></i>
                    <span id="connection-text">连接中...</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- 控制按钮 -->
        <div class="control-buttons">
            <button class="btn btn-success" id="start-btn" onclick="startClient()">
                <i class="bi bi-play-fill"></i> 启动客户端
            </button>
            <button class="btn btn-danger" id="stop-btn" onclick="stopClient()">
                <i class="bi bi-stop-fill"></i> 停止客户端
            </button>
            <button class="btn btn-warning" id="restart-btn" onclick="restartClient()">
                <i class="bi bi-arrow-clockwise"></i> 重启客户端
            </button>
            <div class="ms-auto">
                <span class="status-indicator" id="client-status">
                    <i class="bi bi-circle-fill me-2"></i>
                    <span>状态检测中...</span>
                </span>
            </div>
        </div>

        <!-- 状态卡片 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-link-45deg text-primary" style="font-size: 2rem;"></i>
                        <h4 class="mt-2" id="total-connections">0</h4>
                        <p class="text-muted mb-0">总连接数</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-lightning-fill text-success" style="font-size: 2rem;"></i>
                        <h4 class="mt-2" id="active-connections">0</h4>
                        <p class="text-muted mb-0">活跃连接</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle-fill text-info" style="font-size: 2rem;"></i>
                        <h4 class="mt-2" id="successful-connections">0</h4>
                        <p class="text-muted mb-0">成功连接</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card status-card h-100">
                    <div class="card-body text-center">
                        <i class="bi bi-x-circle-fill text-danger" style="font-size: 2rem;"></i>
                        <h4 class="mt-2" id="failed-connections">0</h4>
                        <p class="text-muted mb-0">失败连接</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 端口映射管理 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-hdd-network"></i> 端口映射管理</span>
                        <button class="btn btn-primary btn-sm" onclick="showAddMappingModal()">
                            <i class="bi bi-plus-circle"></i> 添加映射
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="port-mappings-container">
                            <div class="text-center text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">暂无端口映射，点击上方按钮添加映射</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 客户端信息 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-info-circle"></i> 客户端信息
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>运行时间:</strong></td>
                                <td id="uptime">0小时0分钟</td>
                            </tr>
                            <tr>
                                <td><strong>数据传输:</strong></td>
                                <td id="data-transferred">0 B</td>
                            </tr>
                            <tr>
                                <td><strong>重连次数:</strong></td>
                                <td id="reconnect-attempts">0</td>
                            </tr>
                            <tr>
                                <td><strong>活跃映射:</strong></td>
                                <td id="active-mappings">0</td>
                            </tr>
                            <tr>
                                <td><strong>最后活动:</strong></td>
                                <td id="last-activity">-</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> 连接统计
                    </div>
                    <div class="card-body">
                        <canvas id="connectionChart" class="chart-container"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- 连接历史和日志 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history"></i> 连接历史
                        <span class="badge bg-light text-dark ms-2" id="history-count-badge">0</span>
                    </div>
                    <div class="card-body">
                        <div id="connection-history-list" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-2">暂无连接历史</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-terminal"></i> 实时日志
                        <button class="btn btn-sm btn-light ms-2" onclick="clearLogs()">
                            <i class="bi bi-trash"></i> 清空
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div id="log-container" class="log-container"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加端口映射模态框 -->
    <div class="modal fade" id="addMappingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加端口映射</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMappingForm">
                        <div class="mb-3">
                            <label for="mapping-name" class="form-label">映射名称</label>
                            <input type="text" class="form-control" id="mapping-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="local-host" class="form-label">本地主机</label>
                            <input type="text" class="form-control" id="local-host" value="127.0.0.1" required>
                        </div>
                        <div class="mb-3">
                            <label for="local-port" class="form-label">本地端口</label>
                            <input type="number" class="form-control" id="local-port" min="1" max="65535" required>
                        </div>
                        <div class="mb-3">
                            <label for="preferred-port" class="form-label">首选公网端口（可选）</label>
                            <input type="number" class="form-control" id="preferred-port" min="1" max="65535">
                            <div class="form-text">留空将由服务器自动分配</div>
                        </div>
                        <div class="mb-3">
                            <label for="mapping-protocol" class="form-label">协议类型</label>
                            <select class="form-select" id="mapping-protocol" required>
                                <option value="tcp">TCP（适用于HTTP、HTTPS、Minecraft等）</option>
                                <option value="udp">UDP（适用于DNS、一些游戏服务器等）</option>
                                <option value="both" selected>TCP+UDP混合（适用于L4D2、CS等Source引擎游戏）</option>
                            </select>
                            <div class="form-text">选择适合你的应用程序的协议类型</div>
                        </div>
                        <div class="mb-3">
                            <label for="mapping-description" class="form-label">描述（可选）</label>
                            <textarea class="form-control" id="mapping-description" rows="2"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="auto-reconnect" checked>
                            <label class="form-check-label" for="auto-reconnect">自动重连</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addPortMapping()">添加映射</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑端口映射模态框 -->
    <div class="modal fade" id="editMappingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑端口映射</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editMappingForm">
                        <input type="hidden" id="edit-mapping-id">
                        <div class="mb-3">
                            <label for="edit-mapping-name" class="form-label">映射名称</label>
                            <input type="text" class="form-control" id="edit-mapping-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-local-host" class="form-label">本地主机</label>
                            <input type="text" class="form-control" id="edit-local-host" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-local-port" class="form-label">本地端口</label>
                            <input type="number" class="form-control" id="edit-local-port" min="1" max="65535" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-preferred-port" class="form-label">首选公网端口（可选）</label>
                            <input type="number" class="form-control" id="edit-preferred-port" min="1" max="65535">
                            <div class="form-text">留空将由服务器自动分配</div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-mapping-protocol" class="form-label">协议类型</label>
                            <select class="form-select" id="edit-mapping-protocol" required>
                                <option value="tcp">TCP（适用于HTTP、HTTPS、Minecraft等）</option>
                                <option value="udp">UDP（适用于DNS、一些游戏服务器等）</option>
                                <option value="both">TCP+UDP混合（适用于L4D2、CS等Source引擎游戏）</option>
                            </select>
                            <div class="form-text">选择适合你的应用程序的协议类型</div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-mapping-description" class="form-label">描述（可选）</label>
                            <textarea class="form-control" id="edit-mapping-description" rows="2"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="edit-auto-reconnect">
                            <label class="form-check-label" for="edit-auto-reconnect">自动重连</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updatePortMapping()">保存更改</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Socket.IO连接
        const socket = io();
        
        // 图表配置
        const ctx = document.getElementById('connectionChart').getContext('2d');
        const connectionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '活跃连接数',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }, {
                    label: '重连次数',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });

        // 连接状态管理
        socket.on('connect', () => {
            document.getElementById('connection-status').className = 'bi bi-circle-fill status-online';
            document.getElementById('connection-text').textContent = '已连接';
            addLogEntry('success', 'WebSocket连接已建立', new Date());
        });

        socket.on('disconnect', () => {
            document.getElementById('connection-status').className = 'bi bi-circle-fill status-offline';
            document.getElementById('connection-text').textContent = '连接断开';
            addLogEntry('warning', 'WebSocket连接已断开', new Date());
        });

        // 统计信息更新
        socket.on('stats-update', (stats) => {
            document.getElementById('total-connections').textContent = stats.totalConnections;
            document.getElementById('active-connections').textContent = stats.activeConnections;
            document.getElementById('successful-connections').textContent = stats.successfulConnections;
            document.getElementById('failed-connections').textContent = stats.failedConnections;
            document.getElementById('reconnect-attempts').textContent = stats.reconnectAttempts;
            
            // 更新运行时间
            const uptimeMs = stats.uptime;
            const hours = Math.floor(uptimeMs / (1000 * 60 * 60));
            const minutes = Math.floor((uptimeMs % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('uptime').textContent = `${hours}小时${minutes}分钟`;
            
            // 更新数据传输量
            document.getElementById('data-transferred').textContent = formatBytes(stats.totalDataTransferred);
            
            // 更新最后活动时间
            if (stats.lastActivity) {
                document.getElementById('last-activity').textContent = new Date(stats.lastActivity).toLocaleTimeString();
            }
            
            // 更新活跃映射数
            if (stats.activeMappings !== undefined) {
                document.getElementById('active-mappings').textContent = stats.activeMappings;
            }
            
            // 更新连接历史
            if (stats.connectionHistory) {
                updateConnectionHistory(stats.connectionHistory);
            }
            
            // 更新客户端状态
            updateClientStatus(stats.currentStatus);
            
            // 更新图表
            const now = new Date().toLocaleTimeString();
            if (connectionChart.data.labels.length > 20) {
                connectionChart.data.labels.shift();
                connectionChart.data.datasets[0].data.shift();
                connectionChart.data.datasets[1].data.shift();
            }
            connectionChart.data.labels.push(now);
            connectionChart.data.datasets[0].data.push(stats.activeConnections);
            connectionChart.data.datasets[1].data.push(stats.reconnectAttempts);
            connectionChart.update();
        });

        // 连接历史更新
        socket.on('connection-history', (history) => {
            updateConnectionHistory(history);
        });

        // 连接事件
        socket.on('connection-event', (event) => {
            // 这里可以处理特定的连接事件
            if (event.event === 'tunnel-established') {
                addLogEntry('success', `隧道建立: 连接${event.data.id}`, event.timestamp);
            }
        });

        // 日志消息
        socket.on('log-message', (log) => {
            addLogEntry(log.level, log.message, log.timestamp);
        });

        // 更新客户端状态
        function updateClientStatus(status) {
            const statusElement = document.getElementById('client-status');
            const statusIcon = statusElement.querySelector('i');
            const statusText = statusElement.querySelector('span');
            
            statusElement.className = 'status-indicator';
            console.log(`更新客户端状态: ${status}`);
            switch (status) {
                case 'connected':
                    statusElement.classList.add('status-connected');
                    statusIcon.className = 'bi bi-circle-fill me-2 status-online';
                    statusText.textContent = '已连接';
                    break;
                case 'connecting':
                    statusElement.classList.add('status-connected'); // 使用连接中的样式
                    statusIcon.className = 'bi bi-circle-fill me-2 status-connecting';
                    statusText.textContent = '连接中...';
                    break;
                case 'error':
                    statusElement.classList.add('status-error');
                    statusIcon.className = 'bi bi-circle-fill me-2 status-offline';
                    statusText.textContent = '连接错误';
                    break;
                case 'stopped':
                default:
                    statusElement.classList.add('status-disconnected');
                    statusIcon.className = 'bi bi-circle-fill me-2 status-offline';
                    statusText.textContent = '已停止';
                    break;
            }
        }

        // 更新连接历史列表
        function updateConnectionHistory(history) {
            const container = document.getElementById('connection-history-list');
            document.getElementById('history-count-badge').textContent = history.length;
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">暂无连接历史</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = history.slice(-10).reverse().map(conn => {
                const statusClass = getConnectionStatusClass(conn.status);
                const duration = conn.duration ? formatDuration(conn.duration) : '进行中';
                const errors = conn.errors.length > 0 ? `<br><small class="text-warning">错误: ${conn.errors.length}个</small>` : '';
                
                return `
                    <div class="connection-item ${statusClass}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>连接 #${conn.id}</strong>
                                <br>
                                <small>${getStatusText(conn.status)}</small>
                                ${errors}
                            </div>
                            <div class="text-end">
                                <div class="badge bg-light text-dark">${formatBytes(conn.bytesTransferred)}</div>
                                <br>
                                <small>${duration}</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 获取连接状态类名
        function getConnectionStatusClass(status) {
            switch (status) {
                case 'tunnel-established':
                case 'proxy-connected':
                    return 'active';
                case 'closed':
                    return '';
                default:
                    return 'failed';
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            const statusMap = {
                'connecting': '连接中',
                'proxy-connected': '代理已连接',
                'tunnel-established': '隧道已建立',
                'closed': '已关闭',
                'proxy-connection-failed': '代理连接失败',
                'mc-connection-failed': 'MC连接失败'
            };
            return statusMap[status] || status;
        }

        // 添加日志条目
        function addLogEntry(level, message, timestamp) {
            const container = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${level}`;
            
            const time = new Date(timestamp).toLocaleTimeString();
            logEntry.innerHTML = `
                <span class="text-muted">[${time}]</span> 
                <span class="${level === 'error' ? 'text-danger' : level === 'warning' ? 'text-warning' : level === 'success' ? 'text-success' : 'text-info'}">[${level.toUpperCase()}]</span> 
                ${message}
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // 限制日志条目数量
            if (container.children.length > 500) {
                container.removeChild(container.firstChild);
            }
        }

        // 清空日志
        function clearLogs() {
            document.getElementById('log-container').innerHTML = '';
        }

        // 控制函数
        async function startClient() {
            try {
                const response = await fetch('/api/start', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    addLogEntry('success', result.message, new Date());
                } else {
                    addLogEntry('warning', result.message, new Date());
                }
            } catch (error) {
                addLogEntry('error', '启动请求失败: ' + error.message, new Date());
            }
        }

        async function stopClient() {
            try {
                const response = await fetch('/api/stop', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    addLogEntry('warning', result.message, new Date());
                } else {
                    addLogEntry('warning', result.message, new Date());
                }
            } catch (error) {
                addLogEntry('error', '停止请求失败: ' + error.message, new Date());
            }
        }

        async function restartClient() {
            try {
                const response = await fetch('/api/restart', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    addLogEntry('info', result.message, new Date());
                }
            } catch (error) {
                addLogEntry('error', '重启请求失败: ' + error.message, new Date());
            }
        }

        // 格式化字节数
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化持续时间
        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}时${minutes % 60}分`;
            } else if (minutes > 0) {
                return `${minutes}分${seconds % 60}秒`;
            } else {
                return `${seconds}秒`;
            }
        }

        // 端口映射管理
        let currentMappings = [];
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 添加欢迎日志
            addLogEntry('info', '客户端管理面板已加载', new Date());
            loadPortMappings();
        });
        
        // 加载端口映射
        async function loadPortMappings() {
            try {
                const response = await fetch('/api/mappings');
                currentMappings = await response.json();
                updateMappingsDisplay();
            } catch (error) {
                console.error('加载端口映射失败:', error);
                addLogEntry('error', '加载端口映射失败: ' + error.message, new Date());
            }
        }
        
        // 更新映射显示
        function updateMappingsDisplay() {
            const container = document.getElementById('port-mappings-container');
            
            if (currentMappings.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                        <p class="mt-2">暂无端口映射，点击上方按钮添加映射</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentMappings.map(mapping => `
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <h6 class="mb-1">${mapping.name}</h6>
                                <small class="text-muted">${mapping.description || '无描述'}</small>
                            </div>
                            <div class="col-md-2">
                                <span class="badge bg-info">本地</span><br>
                                <strong>${mapping.localHost}:${mapping.localPort}</strong>
                            </div>
                            <div class="col-md-2">
                                <span class="badge bg-primary">公网</span><br>
                                <strong>${mapping.publicPort || '未分配'}</strong>
                            </div>
                            <div class="col-md-2">
                                <span class="badge bg-warning">协议</span><br>
                                <strong>${(mapping.protocol || 'tcp').toUpperCase()}</strong>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="badge ${mapping.active ? 'bg-success' : 'bg-secondary'}">
                                    ${mapping.active ? '运行中' : '已停止'}
                                </span><br>
                                <small class="text-muted">${mapping.connections || 0} 连接</small>
                            </div>
                            <div class="col-md-2 text-end">
                                <div class="btn-group" role="group">
                                    ${mapping.active ? 
                                        `<button class="btn btn-outline-danger btn-sm" onclick="stopMapping('${mapping.id}')">
                                            <i class="bi bi-stop-fill"></i> 停止
                                        </button>` :
                                        `<button class="btn btn-outline-success btn-sm" onclick="startMapping('${mapping.id}')">
                                            <i class="bi bi-play-fill"></i> 启动
                                        </button>`
                                    }
                                    <button class="btn btn-outline-primary btn-sm" onclick="editMapping('${mapping.id}')">
                                        <i class="bi bi-pencil"></i> 编辑
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteMapping('${mapping.id}')">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // 更新活跃映射统计
            const activeMappings = currentMappings.filter(m => m.active).length;
            document.getElementById('active-mappings').textContent = activeMappings;
        }
        
        // 显示添加映射模态框
        function showAddMappingModal() {
            const modal = new bootstrap.Modal(document.getElementById('addMappingModal'));
            document.getElementById('addMappingForm').reset();
            modal.show();
        }
        
        // 添加端口映射
        async function addPortMapping() {
            const name = document.getElementById('mapping-name').value;
            const localHost = document.getElementById('local-host').value;
            const localPort = parseInt(document.getElementById('local-port').value);
            const preferredPort = document.getElementById('preferred-port').value;
            const protocol = document.getElementById('mapping-protocol').value;
            const description = document.getElementById('mapping-description').value;
            const autoReconnect = document.getElementById('auto-reconnect').checked;
            
            if (!name || !localHost || !localPort || !protocol) {
                alert('请填写必要字段');
                return;
            }
            
            const mappingData = {
                name,
                localHost,
                localPort,
                preferredPort: preferredPort ? parseInt(preferredPort) : null,
                protocol,
                description,
                autoReconnect,
                enabled: true
            };
            
            try {
                const response = await fetch('/api/mappings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mappingData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogEntry('success', '端口映射添加成功: ' + name, new Date());
                    bootstrap.Modal.getInstance(document.getElementById('addMappingModal')).hide();
                    loadPortMappings();
                } else {
                    addLogEntry('error', '添加端口映射失败: ' + result.message, new Date());
                }
            } catch (error) {
                addLogEntry('error', '添加端口映射失败: ' + error.message, new Date());
            }
        }
        
        // 编辑映射
        function editMapping(mappingId) {
            const mapping = currentMappings.find(m => m.id === mappingId);
            if (!mapping) return;
            
            document.getElementById('edit-mapping-id').value = mapping.id;
            document.getElementById('edit-mapping-name').value = mapping.name;
            document.getElementById('edit-local-host').value = mapping.localHost;
            document.getElementById('edit-local-port').value = mapping.localPort;
            document.getElementById('edit-preferred-port').value = mapping.preferredPort || '';
            document.getElementById('edit-mapping-protocol').value = mapping.protocol || 'tcp';
            document.getElementById('edit-mapping-description').value = mapping.description || '';
            document.getElementById('edit-auto-reconnect').checked = mapping.autoReconnect;
            
            const modal = new bootstrap.Modal(document.getElementById('editMappingModal'));
            modal.show();
        }
        
        // 更新端口映射
        async function updatePortMapping() {
            const mappingId = document.getElementById('edit-mapping-id').value;
            const name = document.getElementById('edit-mapping-name').value;
            const localHost = document.getElementById('edit-local-host').value;
            const localPort = parseInt(document.getElementById('edit-local-port').value);
            const preferredPort = document.getElementById('edit-preferred-port').value;
            const protocol = document.getElementById('edit-mapping-protocol').value;
            const description = document.getElementById('edit-mapping-description').value;
            const autoReconnect = document.getElementById('edit-auto-reconnect').checked;
            
            const mappingData = {
                name,
                localHost,
                localPort,
                preferredPort: preferredPort ? parseInt(preferredPort) : null,
                protocol,
                description,
                autoReconnect
            };
            
            try {
                const response = await fetch(`/api/mappings/${mappingId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mappingData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogEntry('success', '端口映射更新成功: ' + name, new Date());
                    bootstrap.Modal.getInstance(document.getElementById('editMappingModal')).hide();
                    loadPortMappings();
                } else {
                    addLogEntry('error', '更新端口映射失败: ' + result.message, new Date());
                }
            } catch (error) {
                addLogEntry('error', '更新端口映射失败: ' + error.message, new Date());
            }
        }
        
        // 启动映射
        async function startMapping(mappingId) {
            try {
                const response = await fetch(`/api/mappings/${mappingId}/start`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogEntry('success', result.message, new Date());
                    loadPortMappings();
                } else {
                    addLogEntry('error', '启动映射失败: ' + result.message, new Date());
                }
            } catch (error) {
                addLogEntry('error', '启动映射失败: ' + error.message, new Date());
            }
        }
        
        // 停止映射
        async function stopMapping(mappingId) {
            try {
                const response = await fetch(`/api/mappings/${mappingId}/stop`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogEntry('warning', result.message, new Date());
                    loadPortMappings();
                } else {
                    addLogEntry('error', '停止映射失败: ' + result.message, new Date());
                }
            } catch (error) {
                addLogEntry('error', '停止映射失败: ' + error.message, new Date());
            }
        }
        
        // 删除映射
        async function deleteMapping(mappingId) {
            const mapping = currentMappings.find(m => m.id === mappingId);
            if (!mapping) return;
            
            if (!confirm(`确认删除端口映射 "${mapping.name}" 吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/mappings/${mappingId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogEntry('warning', '端口映射已删除: ' + mapping.name, new Date());
                    loadPortMappings();
                } else {
                    addLogEntry('error', '删除端口映射失败: ' + result.message, new Date());
                }
            } catch (error) {
                addLogEntry('error', '删除端口映射失败: ' + error.message, new Date());
            }
        }
        
        // 定期刷新映射状态
        setInterval(loadPortMappings, 5000);
    </script>
</body>
</html>
